<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Wallboard WebSocket Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .log { background: #f5f5f5; padding: 10px; border-radius: 5px; height: 200px; overflow-y: scroll; margin: 10px 0; }
        input, button, select { margin: 5px; padding: 8px; }
        .online { color: green; }
        .offline { color: red; }
        .status { padding: 5px; margin: 5px; border-radius: 3px; }
        .Available { background-color: #d4edda; }
        .Busy { background-color: #f8d7da; }
        .Break { background-color: #fff3cd; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåê Agent Wallboard WebSocket Test</h1>
        
        <!-- Connection Status -->
        <div class="section">
            <h3>Connection Status</h3>
            <div id="connectionStatus" class="offline">Disconnected</div>
            <button onclick="connect()">Connect</button>
            <button onclick="disconnect()">Disconnect</button>
        </div>

        <!-- Agent Login -->
        <div class="section">
            <h3>Agent Login</h3>
            <input type="text" id="agentCode" placeholder="Agent Code (e.g., A001)" value="A001">
            <input type="text" id="agentName" placeholder="Agent Name" value="Test Agent">
            <button onclick="agentLogin()">Login as Agent</button>
            <button onclick="agentLogout()">Logout</button>
        </div>

        <!-- Status Update -->
        <div class="section">
            <h3>Update Status</h3>
            <select id="statusSelect">
                <option value="Available">Available</option>
                <option value="Busy">Busy</option>
                <option value="Wrap">Wrap</option>
                <option value="Break">Break</option>
                <option value="Not Ready">Not Ready</option>
                <option value="Offline">Offline</option>
            </select>
            <input type="text" id="statusReason" placeholder="Reason (optional)">
            <button onclick="updateStatus()">Update Status</button>
        </div>

        <!-- Send Message -->
        <div class="section">
            <h3>Send Message</h3>
            <input type="text" id="messageTo" placeholder="To Agent Code (or ALL)" value="ALL">
            <input type="text" id="messageText" placeholder="Message">
            <select id="messageType">
                <option value="message">Message</option>
                <option value="broadcast">Broadcast</option>
                <option value="alert">Alert</option>
            </select>
            <button onclick="sendMessage()">Send Message</button>
        </div>

        <!-- Dashboard -->
        <div class="section">
            <h3>Dashboard</h3>
            <button onclick="joinDashboard()">Join Dashboard</button>
            <div id="dashboardStats"></div>
        </div>

        <!-- Event Log -->
        <div class="section">
            <h3>Event Log</h3>
            <button onclick="clearLog()">Clear Log</button>
            <div id="eventLog" class="log"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket = null;
        
        function log(message) {
            const eventLog = document.getElementById('eventLog');
            const timestamp = new Date().toLocaleTimeString();
            eventLog.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            eventLog.scrollTop = eventLog.scrollHeight;
        }
        
        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.textContent = status;
            statusEl.className = status === 'Connected' ? 'online' : 'offline';
        }
        
        function connect() {
            if (socket) {
                socket.disconnect();
            }
            
            socket = io('http://localhost:3001');
            
            socket.on('connect', () => {
                log('‚úÖ Connected to WebSocket server');
                updateConnectionStatus('Connected');
            });
            
            socket.on('disconnect', () => {
                log('‚ùå Disconnected from WebSocket server');
                updateConnectionStatus('Disconnected');
            });
            
            socket.on('login-success', (data) => {
                log(`üîê Login successful: ${JSON.stringify(data)}`);
            });
            
            socket.on('login-error', (data) => {
                log(`‚ùå Login error: ${data.message}`);
            });
            
            socket.on('agentStatusChanged', (data) => {
                log(`üîÑ Status changed: ${data.agentCode} ${data.previousStatus} ‚Üí ${data.newStatus}`);
            });
            
            socket.on('newMessage', (data) => {
                log(`üí¨ New message: From ${data.from} to ${data.to}: ${data.message}`);
            });
            
            socket.on('agent-online', (data) => {
                log(`üü¢ Agent online: ${data.agentCode} - ${data.agentName}`);
            });
            
            socket.on('agent-offline', (data) => {
                log(`üî¥ Agent offline: ${data.agentCode} - ${data.agentName}`);
            });
            
            socket.on('dashboardUpdate', (data) => {
                log(`üìä Dashboard update: ${data.onlineAgents}/${data.totalAgents} agents online`);
                updateDashboard(data);
            });
        }
        
        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
        }
        
        function agentLogin() {
            if (!socket) {
                log('‚ùå Not connected to server');
                return;
            }
            
            const agentCode = document.getElementById('agentCode').value;
            const agentName = document.getElementById('agentName').value;
            
            socket.emit('agent-login', { agentCode, agentName });
            log(`üîê Attempting login: ${agentCode}`);
        }
        
        function agentLogout() {
            if (!socket) {
                log('‚ùå Not connected to server');
                return;
            }
            
            socket.emit('agent-logout');
            log('üîê Logging out...');
        }
        
        async function updateStatus() {
            const agentCode = document.getElementById('agentCode').value;
            const status = document.getElementById('statusSelect').value;
            const reason = document.getElementById('statusReason').value;
            
            try {
                // Get agent ID first
                const agentsResponse = await fetch('/api/agents');
                const agentsData = await agentsResponse.json();
                const agent = agentsData.data.find(a => a.agentCode === agentCode);
                
                if (!agent) {
                    log(`‚ùå Agent ${agentCode} not found`);
                    return;
                }
                
                // Update status
                const response = await fetch(`/api/agents/${agent._id}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status, reason })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log(`‚úÖ Status updated successfully: ${status}`);
                } else {
                    log(`‚ùå Status update failed: ${result.message}`);
                }
            } catch (error) {
                log(`‚ùå Error updating status: ${error.message}`);
            }
        }
        
        async function sendMessage() {
            const from = document.getElementById('agentName').value || 'Test Supervisor';
            const to = document.getElementById('messageTo').value;
            const message = document.getElementById('messageText').value;
            const type = document.getElementById('messageType').value;
            
            try {
                const response = await fetch('/api/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ from, to, message, type })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log(`‚úÖ Message sent successfully`);
                    document.getElementById('messageText').value = '';
                } else {
                    log(`‚ùå Message send failed: ${result.message}`);
                }
            } catch (error) {
                log(`‚ùå Error sending message: ${error.message}`);
            }
        }
        
        function joinDashboard() {
            if (!socket) {
                log('‚ùå Not connected to server');
                return;
            }
            
            socket.emit('join-dashboard');
            log('üìä Joined dashboard room');
        }
        
        function updateDashboard(data) {
            const dashboardEl = document.getElementById('dashboardStats');
            dashboardEl.innerHTML = `
                <div>Total Agents: ${data.totalAgents}</div>
                <div>Online Agents: <span class="online">${data.onlineAgents}</span></div>
                <div>Offline Agents: <span class="offline">${data.offlineAgents}</span></div>
                <div>Status Breakdown: ${JSON.stringify(data.statusBreakdown)}</div>
                <div>Last Updated: ${new Date(data.timestamp).toLocaleTimeString()}</div>
            `;
        }
        
        function clearLog() {
            document.getElementById('eventLog').innerHTML = '';
        }
        
        // Auto-connect on page load
        window.onload = function() {
            log('üåê WebSocket Test Client loaded');
            log('Click "Connect" to start testing');
        };
    </script>
</body>
</html>